<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <title>Gamers ERP — Backoffice</title>

        <!-- Tailwind (OK pour projet/POC) -->
        <script src="https://cdn.tailwindcss.com"></script>
    </head>

    <body class="bg-slate-50 text-slate-900">
        <div x-data="backoffice()" class="min-h-screen">
            <!-- Header -->
            <header class="bg-white border-b">
                <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                    <div class="font-semibold">Gamers ERP — Backoffice Abonnés</div>

                    <div class="flex items-center gap-3">
                        <template x-if="isAuthed">
                            <div class="text-sm text-slate-600">
                                <span x-text="adminEmail"></span>
                            </div>
                        </template>

                        <template x-if="isAuthed">
                            <button
                                class="px-3 py-1.5 rounded bg-slate-900 text-white hover:bg-slate-800"
                                @click="logout()"
                            >
                                Déconnexion
                            </button>
                        </template>
                    </div>
                </div>
            </header>

            <main class="max-w-6xl mx-auto px-4 py-6">
                <!-- Toast -->
                <template x-if="toast.show">
                    <div
                        class="mb-4 p-3 rounded border bg-white"
                        :class="toast.type==='error' ? 'border-red-300' : 'border-emerald-300'"
                    >
                        <div class="font-medium" x-text="toast.message"></div>
                    </div>
                </template>

                <!-- LOGIN -->
                <section x-show="!isAuthed" class="max-w-md bg-white p-6 rounded-xl border shadow-sm">
                    <h1 class="text-xl font-semibold mb-1">Connexion admin</h1>
                    <p class="text-sm text-slate-600 mb-4">Accès au backoffice abonnés.</p>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">API Base URL</label>
                            <input
                                class="w-full border rounded-lg px-3 py-2"
                                placeholder="http://localhost:3000"
                                x-model="API"
                            />
                            <p class="text-xs text-slate-500 mt-1">
                                Mets l’URL de ton backend (ex: http://localhost:3000).
                            </p>
                        </div>

                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Email</label>
                            <input class="w-full border rounded-lg px-3 py-2" type="email" x-model="loginForm.email" />
                        </div>

                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Mot de passe</label>
                            <input
                                class="w-full border rounded-lg px-3 py-2"
                                type="password"
                                x-model="loginForm.password"
                            />
                        </div>

                        <button
                            class="w-full px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50"
                            :disabled="loading"
                            @click="adminLogin()"
                        >
                            <span x-show="!loading">Se connecter</span>
                            <span x-show="loading">Connexion…</span>
                        </button>
                    </div>
                </section>

                <!-- DASHBOARD -->
                <section x-show="isAuthed" class="flex gap-6">
                    <!-- Sidebar -->
                    <aside class="w-60 bg-white rounded-xl border shadow-sm p-3 h-fit">
                        <div class="text-xs uppercase tracking-wide text-slate-500 px-2 mb-2">Menu</div>
                        <nav class="flex flex-col gap-1">
                            <button
                                class="text-left px-3 py-2 rounded-lg hover:bg-slate-100"
                                :class="route==='users' ? 'bg-slate-100 font-semibold' : ''"
                                @click="go('users')"
                            >
                                Utilisateurs
                            </button>
                            <button
                                class="text-left px-3 py-2 rounded-lg hover:bg-slate-100"
                                :class="route==='subscriptions' ? 'bg-slate-100 font-semibold' : ''"
                                @click="go('subscriptions')"
                            >
                                Abonnements
                            </button>
                        </nav>
                    </aside>

                    <!-- Content -->
                    <div class="flex-1 space-y-6">
                        <!-- USERS -->
                        <section x-show="route==='users'" class="bg-white rounded-xl border shadow-sm p-4">
                            <div class="flex items-end justify-between gap-4 mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold">Utilisateurs</h2>
                                    <p class="text-sm text-slate-600">Liste + filtre + changement de statut.</p>
                                </div>

                                <div class="flex gap-2 items-end">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">Filtre status</label>
                                        <select class="border rounded-lg px-3 py-2" x-model="usersFilter.status">
                                            <option value="">Tous</option>
                                            <option value="OK">OK</option>
                                            <option value="SUSPENDED">SUSPENDED</option>
                                            <option value="BLOCKED">BLOCKED</option>
                                            <option value="DELETED">DELETED</option>
                                        </select>
                                    </div>

                                    <button
                                        class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50"
                                        :disabled="loading"
                                        @click="loadUsers()"
                                    >
                                        Rafraîchir
                                    </button>
                                </div>
                            </div>

                            <div class="overflow-auto border rounded-lg">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">Nom</th>
                                            <th class="text-left p-2">Email</th>
                                            <th class="text-left p-2">Status</th>
                                            <th class="text-left p-2">Paiement</th>
                                            <th class="text-left p-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="u in users" :key="u.id">
                                            <tr class="border-t">
                                                <td class="p-2" x-text="u.firstName + ' ' + u.lastName"></td>
                                                <td class="p-2" x-text="u.email"></td>
                                                <td class="p-2">
                                                    <span
                                                        class="px-2 py-1 rounded bg-slate-100"
                                                        x-text="u.status"
                                                    ></span>
                                                </td>
                                                <td class="p-2" x-text="formatPayment(u.paymentMethod)"></td>
                                                <td class="p-2">
                                                    <div class="flex gap-2 flex-wrap">
                                                        <button
                                                            class="px-2 py-1 rounded border hover:bg-slate-50"
                                                            @click="setUserStatus(u.id, 'OK')"
                                                        >
                                                            OK
                                                        </button>
                                                        <button
                                                            class="px-2 py-1 rounded border hover:bg-slate-50"
                                                            @click="setUserStatus(u.id, 'SUSPENDED')"
                                                        >
                                                            Suspend
                                                        </button>
                                                        <button
                                                            class="px-2 py-1 rounded border hover:bg-slate-50"
                                                            @click="setUserStatus(u.id, 'BLOCKED')"
                                                        >
                                                            Block
                                                        </button>
                                                        <button
                                                            class="px-2 py-1 rounded border hover:bg-slate-50"
                                                            @click="openSubsForUser(u.id)"
                                                        >
                                                            Voir abonnements
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>

                                        <template x-if="users.length===0 && !loading">
                                            <tr>
                                                <td class="p-3 text-slate-500" colspan="5">Aucun utilisateur.</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <!-- SUBSCRIPTIONS -->
                        <section x-show="route==='subscriptions'" class="bg-white rounded-xl border shadow-sm p-4">
                            <div class="flex items-end justify-between gap-4 mb-4">
                                <div>
                                    <h2 class="text-lg font-semibold">Abonnements</h2>
                                    <p class="text-sm text-slate-600">Liste + filtre + résiliation.</p>
                                </div>

                                <div class="flex gap-2 items-end flex-wrap">
                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">userId</label>
                                        <input
                                            class="border rounded-lg px-3 py-2 w-72"
                                            placeholder="UUID userId (optionnel)"
                                            x-model="subsFilter.userId"
                                        />
                                    </div>

                                    <div>
                                        <label class="block text-xs text-slate-600 mb-1">status</label>
                                        <select class="border rounded-lg px-3 py-2" x-model="subsFilter.status">
                                            <option value="">Tous</option>
                                            <option value="ACTIVE">ACTIVE</option>
                                            <option value="CANCELLED">CANCELLED</option>
                                            <option value="PENDING_CANCEL">PENDING_CANCEL</option>
                                        </select>
                                    </div>

                                    <button
                                        class="px-3 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50"
                                        :disabled="loading"
                                        @click="loadSubscriptions()"
                                    >
                                        Rafraîchir
                                    </button>
                                </div>
                            </div>

                            <div class="overflow-auto border rounded-lg">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="text-left p-2">Contract</th>
                                            <th class="text-left p-2">UserId</th>
                                            <th class="text-left p-2">Début</th>
                                            <th class="text-left p-2">Fin</th>
                                            <th class="text-left p-2">Montant</th>
                                            <th class="text-left p-2">Status</th>
                                            <th class="text-left p-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="s in subscriptions" :key="s.id">
                                            <tr class="border-t">
                                                <td class="p-2" x-text="s.contractCode"></td>
                                                <td class="p-2 font-mono text-xs" x-text="s.userId"></td>
                                                <td class="p-2" x-text="s.startDate"></td>
                                                <td class="p-2" x-text="s.endDate ?? '-'"></td>
                                                <td class="p-2" x-text="formatMoney(s.monthlyAmount)"></td>
                                                <td class="p-2">
                                                    <span
                                                        class="px-2 py-1 rounded bg-slate-100"
                                                        x-text="s.status"
                                                    ></span>
                                                </td>
                                                <td class="p-2">
                                                    <button
                                                        class="px-2 py-1 rounded border hover:bg-slate-50 disabled:opacity-50"
                                                        :disabled="loading"
                                                        @click="cancelSubscription(s.id)"
                                                    >
                                                        Résilier
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>

                                        <template x-if="subscriptions.length===0 && !loading">
                                            <tr>
                                                <td class="p-3 text-slate-500" colspan="7">Aucun abonnement.</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                </section>
            </main>
        </div>

        <!-- Alpine -->
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.data('backoffice', () => ({
                    // config
                    API: 'http://localhost:3000',

                    // state
                    loading: false,
                    route: 'users',
                    isAuthed: false,
                    token: localStorage.getItem('admin_token') || '',
                    adminEmail: '',

                    // forms
                    loginForm: { email: '', password: '' },

                    // data
                    users: [],
                    subscriptions: [],

                    // filters
                    usersFilter: { status: '' },
                    subsFilter: { userId: '', status: '' },

                    toast: { show: false, type: 'ok', message: '' },

                    init() {
                        this.isAuthed = !!this.token;
                        if (this.isAuthed) {
                            // si tu veux, tu peux décoder le JWT, mais simple: email dans localStorage après login
                            const savedEmail = localStorage.getItem('admin_email');
                            this.adminEmail = savedEmail || '';
                            this.loadUsers();
                        }
                    },

                    notify(message, type = 'ok') {
                        this.toast = { show: true, type, message };
                        setTimeout(() => (this.toast.show = false), 2500);
                    },

                    go(route) {
                        this.route = route;
                        if (route === 'users') this.loadUsers();
                        if (route === 'subscriptions') this.loadSubscriptions();
                    },

                    logout() {
                        localStorage.removeItem('admin_token');
                        localStorage.removeItem('admin_email');
                        this.token = '';
                        this.adminEmail = '';
                        this.isAuthed = false;
                        this.users = [];
                        this.subscriptions = [];
                        this.notify('Déconnecté.');
                    },

                    // ---- API helper
                    async request(path, { method = 'GET', body, auth = true } = {}) {
                        const headers = {};
                        if (body) headers['Content-Type'] = 'application/json';
                        if (auth && this.token) headers['Authorization'] = `Bearer ${this.token}`;

                        const r = await fetch(`${this.API}${path}`, {
                            method,
                            headers,
                            body: body ? JSON.stringify(body) : undefined,
                        });

                        const text = await r.text();
                        let data = null;
                        try {
                            data = text ? JSON.parse(text) : null;
                        } catch {}

                        if (!r.ok) {
                            const msg = data?.message || `HTTP ${r.status}`;
                            const err = new Error(msg);
                            err.status = r.status;
                            err.data = data;
                            throw err;
                        }
                        return data;
                    },

                    // ---- Auth
                    async adminLogin() {
                        this.loading = true;
                        try {
                            const res = await this.request('/auth/admin/login', {
                                method: 'POST',
                                body: { email: this.loginForm.email, password: this.loginForm.password },
                                auth: false,
                            });

                            const token = res?.payload?.token;
                            const admin = res?.payload?.admin;

                            if (!token) throw new Error('Token manquant dans payload.token');

                            this.token = token;
                            localStorage.setItem('admin_token', token);

                            const email = admin?.email || this.loginForm.email || '';
                            this.adminEmail = email;
                            localStorage.setItem('admin_email', email);

                            this.isAuthed = true;
                            this.notify('Connecté.');
                            this.route = 'users';
                            await this.loadUsers();
                        } catch (e) {
                            this.notify(e.message || 'Erreur login', 'error');
                        } finally {
                            this.loading = false;
                        }
                    },

                    // ---- Users
                    async loadUsers() {
                        this.loading = true;
                        try {
                            const qs = this.usersFilter.status
                                ? `?status=${encodeURIComponent(this.usersFilter.status)}`
                                : '';
                            const res = await this.request(`/users${qs}`);
                            this.users = res?.payload ?? [];
                        } catch (e) {
                            if (e.status === 401 || e.status === 403) this.logout();
                            this.notify(e.message || 'Erreur chargement users', 'error');
                        } finally {
                            this.loading = false;
                        }
                    },

                    async setUserStatus(userId, status) {
                        this.loading = true;
                        try {
                            await this.request(`/users/${userId}/status`, {
                                method: 'PATCH',
                                body: { status },
                            });
                            this.notify(`Statut mis à jour: ${status}`);
                            await this.loadUsers();
                        } catch (e) {
                            this.notify(e.message || 'Erreur update statut', 'error');
                        } finally {
                            this.loading = false;
                        }
                    },

                    openSubsForUser(userId) {
                        this.subsFilter.userId = userId;
                        this.route = 'subscriptions';
                        this.loadSubscriptions();
                    },

                    // ---- Subscriptions
                    async loadSubscriptions() {
                        this.loading = true;
                        try {
                            const params = new URLSearchParams();
                            if (this.subsFilter.userId) params.set('userId', this.subsFilter.userId);
                            if (this.subsFilter.status) params.set('status', this.subsFilter.status);
                            const qs = params.toString() ? `?${params.toString()}` : '';
                            const res = await this.request(`/subscriptions${qs}`);
                            this.subscriptions = res?.payload ?? [];
                        } catch (e) {
                            if (e.status === 401 || e.status === 403) this.logout();
                            this.notify(e.message || 'Erreur chargement abonnements', 'error');
                        } finally {
                            this.loading = false;
                        }
                    },

                    async cancelSubscription(subscriptionId) {
                        this.loading = true;
                        try {
                            await this.request(`/subscriptions/${subscriptionId}`, { method: 'DELETE' });
                            this.notify('Abonnement résilié.');
                            await this.loadSubscriptions();
                        } catch (e) {
                            this.notify(e.message || 'Erreur résiliation', 'error');
                        } finally {
                            this.loading = false;
                        }
                    },

                    // ---- Formatters
                    formatMoney(v) {
                        if (typeof v !== 'number') return '-';
                        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(v);
                    },
                    formatPayment(pm) {
                        if (!pm) return '-';
                        if (pm.type === 'SEPA') return `SEPA (${pm.iban ?? 'IBAN masqué'})`;
                        if (pm.type === 'CARD') return `CB (**** ${pm.cardLast4 ?? '----'})`;
                        return pm.type ?? '-';
                    },
                }));
            });
        </script>
    </body>
</html>
